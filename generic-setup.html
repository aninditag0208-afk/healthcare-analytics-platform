<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Indication Setup - Healthcare Analytics Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="analytics-state.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #2d2d2d 100%);
        }

        .chat-bubble {
            max-width: 80%;
            animation: fadeInUp 0.5s ease;
        }

        .chat-bubble.ai {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-bubble.user {
            background: linear-gradient(135deg, #2dd4bf 0%, #0d4f4f 100%);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .typing-indicator {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .chat-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .chat-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #2dd4bf;
            outline: none;
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.1);
        }

        .progress-sidebar {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .progress-step {
            transition: all 0.3s ease;
        }

        .progress-step.active {
            background: rgba(45, 212, 191, 0.2);
            border-color: #2dd4bf;
        }

        .progress-step.completed {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }

        .suggested-response {
            background: rgba(45, 212, 191, 0.1);
            border: 1px solid rgba(45, 212, 191, 0.3);
            transition: all 0.3s ease;
        }

        .suggested-response:hover {
            background: rgba(45, 212, 191, 0.2);
            border-color: #2dd4bf;
        }
    </style>
</head>
<body class="h-screen gradient-bg flex">
    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-white/10">
            <div class="flex items-center">
                <button class="text-white/80 hover:text-white mr-4" onclick="goBack()">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div class="w-8 h-8 bg-white rounded flex items-center justify-center mr-3">
                    <span class="text-gray-800 text-sm font-bold">ZS</span>
                </div>
                <div>
                    <h1 class="text-white text-lg font-medium">New Indication Setup</h1>
                    <p class="text-white/60 text-sm">Configure patient journey analysis for any indication</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button class="text-white/80 hover:text-white text-xl">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="w-8 h-8 bg-white/20 rounded-full"></div>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div class="flex-1 overflow-y-auto p-6" id="chatMessages">
            <!-- Initial AI Message -->
            <div class="flex items-start space-x-4 mb-6">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="chat-bubble ai rounded-lg p-4 text-white">
                    <div class="flex items-center mb-2">
                        <span class="font-medium">AI Research Assistant</span>
                        <span class="text-xs text-white/60 ml-2">Just now</span>
                    </div>
                    <p class="mb-3">Hello! I'm here to help you set up a patient journey analysis using real-world claims data for any therapeutic indication.</p>
                    <p>Let's start by identifying which indication you'd like to analyze. What therapeutic area or specific condition interests you?</p>
                </div>
            </div>

            <!-- Suggested Response Buttons -->
            <div class="flex flex-wrap gap-3 mb-6 ml-14" id="suggestedResponses">
                <button class="suggested-response px-4 py-2 rounded-full text-sm text-teal-300 font-medium" onclick="selectSuggestion(this)">
                    Oncology (specify cancer type)
                </button>
                <button class="suggested-response px-4 py-2 rounded-full text-sm text-teal-300 font-medium" onclick="selectSuggestion(this)">
                    Immunology (RA, psoriasis, IBD)
                </button>
                <button class="suggested-response px-4 py-2 rounded-full text-sm text-teal-300 font-medium" onclick="selectSuggestion(this)">
                    Cardiology (heart failure, CAD)
                </button>
                <button class="suggested-response px-4 py-2 rounded-full text-sm text-teal-300 font-medium" onclick="selectSuggestion(this)">
                    Neurology (MS, Alzheimer's, epilepsy)
                </button>
                <button class="suggested-response px-4 py-2 rounded-full text-sm text-teal-300 font-medium" onclick="selectSuggestion(this)">
                    Rare diseases
                </button>
            </div>
        </div>

        <!-- Chat Input Area -->
        <div class="border-t border-white/10 p-6">
            <div class="flex items-end space-x-4">
                <div class="flex-1">
                    <div class="relative">
                        <textarea
                            id="messageInput"
                            class="chat-input w-full rounded-lg px-4 py-3 text-white placeholder-white/60 resize-none"
                            placeholder="Type the indication you'd like to analyze..."
                            rows="1"
                            style="min-height: 44px; max-height: 120px;"
                        ></textarea>
                    </div>
                    <div class="text-xs text-white/40 mt-1">
                        Press Shift + Enter for new line, Enter to send
                    </div>
                </div>
                <button
                    id="sendButton"
                    onclick="sendMessage()"
                    class="bg-teal-500 hover:bg-teal-600 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-lg px-6 py-3 transition-colors font-medium"
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Sidebar -->
    <div class="w-80 progress-sidebar p-6" id="progressSidebar">
        <div class="sticky top-0">
            <h3 class="text-white text-lg font-semibold mb-6">Setup Progress</h3>

            <!-- Progress Steps -->
            <div class="space-y-4 mb-8">
                <div class="progress-step border border-white/20 rounded-lg p-4 active" id="step1">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-teal-500 rounded-full flex items-center justify-center mr-3 text-sm">
                            <i class="fas fa-stethoscope text-white"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium text-sm">Indication Selection</div>
                            <div class="text-white/60 text-xs">Choose therapeutic area</div>
                        </div>
                    </div>
                </div>

                <div class="progress-step border border-white/20 rounded-lg p-4" id="step2">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3 text-sm">
                            <i class="fas fa-target text-white/60"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium text-sm">Research Objectives</div>
                            <div class="text-white/60 text-xs">Define analysis goals</div>
                        </div>
                    </div>
                </div>

                <div class="progress-step border border-white/20 rounded-lg p-4" id="step3">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3 text-sm">
                            <i class="fas fa-users text-white/60"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium text-sm">Patient Population</div>
                            <div class="text-white/60 text-xs">Define inclusion criteria</div>
                        </div>
                    </div>
                </div>

                <div class="progress-step border border-white/20 rounded-lg p-4" id="step4">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3 text-sm">
                            <i class="fas fa-database text-white/60"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium text-sm">Data Sources</div>
                            <div class="text-white/60 text-xs">Select claims databases</div>
                        </div>
                    </div>
                </div>

                <div class="progress-step border border-white/20 rounded-lg p-4" id="step5">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3 text-sm">
                            <i class="fas fa-shopping-basket text-white/60"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium text-sm">Market Basket</div>
                            <div class="text-white/60 text-xs">Comorbidities & events</div>
                        </div>
                    </div>
                </div>

                <div class="progress-step border border-white/20 rounded-lg p-4" id="step6">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3 text-sm">
                            <i class="fas fa-users-cog text-white/60"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium text-sm">Patient Cohort</div>
                            <div class="text-white/60 text-xs">Define cohort criteria</div>
                        </div>
                    </div>
                </div>

                <div class="progress-step border border-white/20 rounded-lg p-4" id="step7">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3 text-sm">
                            <i class="fas fa-pills text-white/60"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium text-sm">Episodes & Regimens</div>
                            <div class="text-white/60 text-xs">Treatment definitions</div>
                        </div>
                    </div>
                </div>

                <div class="progress-step border border-white/20 rounded-lg p-4" id="step8">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3 text-sm">
                            <i class="fas fa-route text-white/60"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium text-sm">Journey Progression</div>
                            <div class="text-white/60 text-xs">Line advancement logic</div>
                        </div>
                    </div>
                </div>

                <div class="progress-step border border-white/20 rounded-lg p-4" id="step9">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3 text-sm">
                            <i class="fas fa-chart-line text-white/60"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium text-sm">Analytics Setup</div>
                            <div class="text-white/60 text-xs">Configure outputs</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overall Progress -->
            <div class="bg-white/10 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white font-medium text-sm">Completion</span>
                    <span class="text-white text-sm" id="overallProgress">0%</span>
                </div>
                <div class="w-full bg-white/20 rounded-full h-2">
                    <div class="bg-teal-400 h-2 rounded-full transition-all duration-500" style="width: 0%" id="progressBar"></div>
                </div>
                <div class="text-white/60 text-xs mt-2" id="progressStatus">
                    Selecting indication...
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let conversationData = {};
        let isProcessing = false;
        let geminiAPI = null;
        let selectedIndication = '';
        let hasCompletedSteps = new Set();

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Generic Indication Setup loaded');

            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', autoResizeTextarea);
            messageInput.addEventListener('keydown', handleKeyDown);

            initializeGeminiAPI();
            updateLandingPageStatus('in-progress');
        });

        function initializeGeminiAPI() {
            const apiKey = window.GEMINI_API_KEY || null;

            if (apiKey) {
                geminiAPI = {
                    apiKey: apiKey,
                    apiUrl: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent',

                    async generateResponse(userMessage, context = '') {
                        try {
                            const response = await fetch(`${this.apiUrl}?key=${this.apiKey}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [{
                                            text: `You are an AI assistant helping configure patient journey analysis from claims data.

Healthcare Context: In claims data analysis, Dx refers to diagnosis codes (ICD-10) that identify medical conditions, and Rx refers to prescription claims (NDC codes) that capture medication dispensing. Claims data includes medical claims (procedures, visits) and pharmacy claims (prescriptions).

Current Context: ${context}

User message: ${userMessage}

Respond appropriately to help guide the conversation forward. Be concise, healthcare-focused, and acknowledge their input before moving to next steps.`
                                        }]
                                    }],
                                    generationConfig: {
                                        temperature: 0.7,
                                        maxOutputTokens: 200,
                                    }
                                })
                            });

                            if (!response.ok) throw new Error('API request failed');

                            const data = await response.json();
                            return data.candidates[0].content.parts[0].text;
                        } catch (error) {
                            console.warn('Gemini API error:', error);
                            return this.getFallbackResponse(userMessage);
                        }
                    },

                    getFallbackResponse(userMessage) {
                        return `Thank you for specifying "${userMessage}". This is an excellent choice for patient journey analysis. Let me help you configure a comprehensive study for this indication.`;
                    }
                };
                console.log('Gemini API initialized');
            } else {
                console.log('No Gemini API key found, using fallback responses');
            }
        }

        function autoResizeTextarea() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function selectSuggestion(button) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = button.textContent.trim();
            messageInput.focus();

            document.querySelectorAll('.suggested-response').forEach(btn => {
                btn.classList.remove('bg-teal-500/30', 'border-teal-400');
            });
            button.classList.add('bg-teal-500/30', 'border-teal-400');
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message || isProcessing) return;

            isProcessing = true;
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            addUserMessage(message);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Store conversation data
            conversationData[`step${currentStep}`] = message;

            hideSuggestions();
            showTypingIndicator();

            try {
                let aiResponse;
                let nextStepQuestion = '';
                let nextSuggestions = [];

                // Use Gemini for natural conversation or fallback to structured flow
                if (geminiAPI) {
                    const context = getContextForStep(currentStep, message);
                    aiResponse = await geminiAPI.generateResponse(message, context);
                } else {
                    aiResponse = getFallbackResponse(currentStep, message);
                }

                hideTypingIndicator();
                addAIMessage(aiResponse);

                // Mark current step as completed and move to next
                updateStepProgress(currentStep, 'completed');
                currentStep++;

                // Continue conversation flow
                if (currentStep <= 11) {
                    updateStepProgress(currentStep, 'active');
                    updateOverallProgress((currentStep - 1) / 11 * 100);

                    // Get next step question and suggestions
                    const nextStep = getNextStepContent(currentStep);

                    await new Promise(resolve => setTimeout(resolve, 1000));
                    showTypingIndicator();
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    hideTypingIndicator();

                    addAIMessage(nextStep.question);
                    showSuggestions(nextStep.suggestions);
                } else {
                    // Complete setup
                    await completeGenericSetup();
                }
            } catch (error) {
                console.error('Error in sendMessage:', error);
                hideTypingIndicator();
                addAIMessage('I apologize for the error. Let me help you continue. Could you tell me more about what you\'re looking for?');
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                isProcessing = false;
            }
        }

        function getContextForStep(step, userMessage) {
            const indication = conversationData.step1 || selectedIndication || 'general indication';
            const indicationContext = getIndicationContext(indication);

            const stepContexts = {
                1: `User is selecting a therapeutic indication: ${userMessage}. ${indicationContext} Acknowledge their choice and prepare to move to research objectives.`,
                2: `User defined research objectives for ${indication}. Their input: ${userMessage}. ${indicationContext} Acknowledge and prepare to discuss patient population.`,
                3: `User specified patient population criteria for ${indication}. Their input: ${userMessage}. ${indicationContext} Acknowledge and move to data sources discussion.`,
                4: `User selected data sources for ${indication} analysis. Their input: ${userMessage}. Acknowledge and move to market basket analysis.`,
                5: `User discussed market basket needs for ${indication}. Their input: ${userMessage}. ${indicationContext} Acknowledge and move to patient cohort definition.`,
                6: `User defined patient cohort criteria for ${indication}. Their input: ${userMessage}. Acknowledge and move to episodes and regimens.`,
                7: `User specified episode and regimen preferences for ${indication}. Their input: ${userMessage}. ${indicationContext} Acknowledge and move to journey progression.`,
                8: `User discussed journey progression logic for ${indication}. Their input: ${userMessage}. Acknowledge and move to analytics setup.`,
                9: `User specified analytics preferences for ${indication}. Their input: ${userMessage}. Acknowledge their final input and prepare for completion.`
            };

            return stepContexts[step] || `User provided input for step ${step}: ${userMessage}. Acknowledge their input and help progress the conversation.`;
        }

        function getIndicationContext(indication) {
            const lowerIndication = indication.toLowerCase();

            if (lowerIndication.includes('obesity')) {
                return 'Context: Obesity is a metabolic condition managed primarily through lifestyle interventions, medications (GLP-1 agonists, orlistat), and bariatric surgery. No biomarkers are typically used for treatment selection. Focus on BMI categories, comorbidities like diabetes and cardiovascular disease, and treatment persistence with weight management interventions.';
            } else if (lowerIndication.includes('diabetes')) {
                return 'Context: Diabetes management includes metformin, insulin, GLP-1 agonists, SGLT2 inhibitors. Key metrics include HbA1c, treatment adherence, and progression through therapy lines. Comorbidities include cardiovascular and renal complications.';
            } else if (lowerIndication.includes('hypertension')) {
                return 'Context: Hypertension treatment includes ACE inhibitors, ARBs, diuretics, calcium channel blockers. Focus on blood pressure control, medication adherence, and cardiovascular outcomes.';
            } else if (lowerIndication.includes('depression')) {
                return 'Context: Depression treatment includes SSRIs, SNRIs, atypical antidepressants, therapy. Focus on treatment response, medication switches, and persistence. No biomarkers for treatment selection.';
            } else if (lowerIndication.includes('cancer') || lowerIndication.includes('oncology')) {
                return 'Context: Cancer treatment may involve biomarker testing for targeted therapies, treatment lines, progression patterns, and resistance mechanisms.';
            } else {
                return `Context: For ${indication}, focus on relevant treatment patterns, patient characteristics, and clinical outcomes specific to this condition.`;
            }
        }

        function getIndicationSpecificSuggestions(indication, category) {
            const lowerIndication = indication.toLowerCase();

            if (lowerIndication.includes('obesity')) {
                return getObesitySuggestions(category);
            } else if (lowerIndication.includes('diabetes')) {
                return getDiabetesSuggestions(category);
            } else if (lowerIndication.includes('hypertension')) {
                return getHypertensionSuggestions(category);
            } else if (lowerIndication.includes('depression')) {
                return getDepressionSuggestions(category);
            } else if (lowerIndication.includes('cancer') || lowerIndication.includes('oncology')) {
                return getOncologySuggestions(category);
            } else {
                return getGenericSuggestions(indication, category);
            }
        }

        function getObesitySuggestions(category) {
            switch(category) {
                case 'objectives':
                    return [
                        'Weight loss effectiveness and sustainability',
                        'Treatment persistence with anti-obesity medications',
                        'Healthcare resource utilization and costs',
                        'Progression to bariatric surgery',
                        'Management of obesity-related comorbidities'
                    ];
                case 'population':
                    return [
                        'All obesity patients (BMI ≥30)',
                        'Severe obesity patients (BMI ≥35)',
                        'Obesity with comorbidities (diabetes, hypertension)',
                        'Specific age groups (pediatric, elderly)',
                        'Patients by obesity class (I, II, III)'
                    ];
                case 'biomarkers_population':
                    return [
                        'All obesity patients regardless of metabolic markers',
                        'Focus on patients with specific BMI categories',
                        'Stratify by diabetes and metabolic syndrome status',
                        'Include both tested and untested metabolic panels',
                        'No biomarker stratification needed for obesity'
                    ];
                case 'market_basket':
                    return [
                        'Include obesity-related comorbidities (diabetes, hypertension, sleep apnea)',
                        'Focus on cardiovascular comorbidities only',
                        'Include metabolic syndrome components',
                        'No additional factors - focus purely on weight management',
                        'Include mental health comorbidities (depression, anxiety)'
                    ];
                default:
                    return [];
            }
        }

        function getDiabetesSuggestions(category) {
            switch(category) {
                case 'objectives':
                    return [
                        'Glycemic control and HbA1c targets',
                        'Treatment intensification patterns',
                        'Medication adherence and persistence',
                        'Cardiovascular and renal outcomes',
                        'Healthcare costs and resource utilization'
                    ];
                case 'population':
                    return [
                        'All diabetes patients (Type 1 & 2)',
                        'Type 2 diabetes only',
                        'Newly diagnosed patients',
                        'Patients with cardiovascular disease',
                        'Patients with renal complications'
                    ];
                case 'biomarkers_population':
                    return [
                        'All diabetes patients regardless of genetic testing',
                        'Focus on patients with specific HbA1c ranges',
                        'Stratify by insulin resistance markers',
                        'Include both Type 1 and Type 2 molecular profiles',
                        'No genetic biomarker stratification needed'
                    ];
                case 'market_basket':
                    return [
                        'Include diabetes complications (cardiovascular, renal, neuropathy)',
                        'Focus on cardiovascular comorbidities only',
                        'Include all major comorbidities and complications',
                        'No additional factors - focus purely on glycemic management',
                        'Include medication-related adverse events'
                    ];
                default:
                    return [];
            }
        }

        function getHypertensionSuggestions(category) {
            switch(category) {
                case 'objectives':
                    return [
                        'Blood pressure control and targets',
                        'Antihypertensive medication patterns',
                        'Treatment adherence and persistence',
                        'Cardiovascular event prevention',
                        'Healthcare utilization and costs'
                    ];
                case 'population':
                    return [
                        'All hypertensive patients',
                        'Newly diagnosed hypertension',
                        'Resistant hypertension patients',
                        'Hypertension with comorbidities',
                        'Specific age groups or risk categories'
                    ];
                case 'market_basket':
                    return [
                        'Include cardiovascular comorbidities and events',
                        'Focus on target organ damage only',
                        'Include all major comorbidities',
                        'No additional factors - focus purely on blood pressure control',
                        'Include medication-related adverse events'
                    ];
                default:
                    return [];
            }
        }

        function getDepressionSuggestions(category) {
            switch(category) {
                case 'objectives':
                    return [
                        'Treatment response and remission rates',
                        'Medication switches and augmentation',
                        'Treatment persistence and adherence',
                        'Healthcare resource utilization',
                        'Real-world effectiveness outcomes'
                    ];
                case 'population':
                    return [
                        'All depression patients',
                        'Major depressive disorder only',
                        'Treatment-resistant depression',
                        'Specific age groups or demographics',
                        'Depression with comorbid conditions'
                    ];
                case 'market_basket':
                    return [
                        'Include mental health comorbidities (anxiety, bipolar)',
                        'Focus on medication-related adverse events only',
                        'Include all psychiatric and medical comorbidities',
                        'No additional factors - focus purely on depression treatment',
                        'Include suicide risk and safety events'
                    ];
                default:
                    return [];
            }
        }

        function getOncologySuggestions(category) {
            switch(category) {
                case 'objectives':
                    return [
                        'Treatment patterns and sequencing',
                        'Biomarker testing and targeted therapy use',
                        'Time to treatment initiation',
                        'Treatment persistence and adherence',
                        'Real-world effectiveness outcomes'
                    ];
                case 'population':
                    return [
                        'All cancer patients',
                        'Newly diagnosed patients only',
                        'Metastatic patients',
                        'Patients with specific biomarkers',
                        'Specific age groups or demographics'
                    ];
                case 'biomarkers_population':
                    return [
                        'Include all patients regardless of biomarker testing',
                        'Focus on biomarker-positive patients only',
                        'Stratify by biomarker testing patterns',
                        'Include both tested and untested patient populations',
                        'Focus on specific molecular subtypes'
                    ];
                case 'market_basket':
                    return [
                        'Include treatment-related adverse events',
                        'Focus on biomarker testing patterns',
                        'Include both adverse events and comorbidities',
                        'No additional factors - focus purely on treatment patterns',
                        'Include supportive care and complications'
                    ];
                default:
                    return [];
            }
        }

        function getGenericSuggestions(indication, category) {
            switch(category) {
                case 'objectives':
                    return [
                        `Treatment patterns and sequencing for ${indication}`,
                        'Time to treatment initiation and delays',
                        'Healthcare resource utilization and costs',
                        'Treatment persistence and adherence',
                        'Real-world effectiveness outcomes'
                    ];
                case 'population':
                    return [
                        `All ${indication} patients`,
                        'Newly diagnosed patients only',
                        'Treatment-experienced patients',
                        'Specific age groups or demographics',
                        'Patients with relevant characteristics'
                    ];
                case 'biomarkers_population':
                    return [
                        `All ${indication} patients regardless of biomarker status`,
                        'Patients with specific molecular characteristics',
                        'Focus on biomarker-defined subgroups',
                        'Include both tested and untested patients',
                        'Stratify by biomarker testing patterns'
                    ];
                case 'market_basket':
                    return [
                        'Include relevant comorbidities and complications',
                        'Focus on treatment-related adverse events',
                        'Include both comorbidities and adverse events',
                        'No additional factors - focus purely on treatment patterns',
                        'Include condition-specific complications'
                    ];
                default:
                    return [];
            }
        }

        function getBiomarkerQuestion(indication) {
            const lowerIndication = indication.toLowerCase();

            if (lowerIndication.includes('nsclc') || lowerIndication.includes('lung cancer')) {
                return `For NSCLC analysis, are specific biomarkers important for your research focus? Key biomarkers include EGFR mutations, ALK rearrangements, ROS1, PD-L1 expression, and KRAS mutations.`;
            } else if (lowerIndication.includes('breast cancer')) {
                return `For breast cancer analysis, which biomarkers are critical for your patient stratification? Key markers include HER2 status, hormone receptor status (ER/PR), and BRCA mutations.`;
            } else if (lowerIndication.includes('colorectal') || lowerIndication.includes('crc')) {
                return `For colorectal cancer, are you interested in specific biomarker-driven treatment patterns? Important biomarkers include KRAS, NRAS, BRAF mutations, and microsatellite instability (MSI).`;
            } else if (lowerIndication.includes('melanoma')) {
                return `For melanoma analysis, which biomarkers should we consider for treatment stratification? Key biomarkers include BRAF mutations, NRAS mutations, and PD-L1 expression.`;
            } else if (lowerIndication.includes('ovarian')) {
                return `For ovarian cancer, are BRCA mutations and homologous recombination deficiency (HRD) status important for your analysis focus?`;
            } else if (lowerIndication.includes('prostate')) {
                return `For prostate cancer, should we consider biomarkers like AR-V7, BRCA mutations, or PSA dynamics in the treatment pathway analysis?`;
            } else if (lowerIndication.includes('cancer') || lowerIndication.includes('oncology') || lowerIndication.includes('tumor') || lowerIndication.includes('carcinoma') || lowerIndication.includes('sarcoma') || lowerIndication.includes('lymphoma') || lowerIndication.includes('leukemia')) {
                return `For ${indication} analysis, are there specific biomarkers or molecular characteristics that are important for treatment selection and patient stratification in your research?`;
            } else {
                return `For ${indication} analysis, are there any specific diagnostic markers, genetic factors, or patient characteristics that are important for treatment stratification in your research?`;
            }
        }

        function getFallbackResponse(step, userMessage) {
            const indication = conversationData.step1 || selectedIndication || 'your indication';

            const responses = {
                1: `Excellent choice! I'll help you set up a comprehensive patient journey analysis for ${userMessage}. Let's dive into the specific aspects you want to focus on.`,
                2: `Perfect! Understanding ${userMessage} will be key to your ${indication} analysis. This focus will help us configure the right data and metrics.`,
                3: `Great! Your patient population criteria (${userMessage}) will help us identify the right cohort for analysis.`,
                4: `Excellent! Using ${userMessage} will provide the comprehensive data coverage we need for your analysis.`,
                5: `Perfect! Your approach to ${userMessage} will be important for understanding the broader clinical context.`,
                6: `Great! Your cohort definition approach (${userMessage}) will ensure we capture the right patient journey patterns.`,
                7: `Excellent! Your episode and regimen preferences (${userMessage}) will help us accurately map treatment patterns.`,
                8: `Perfect! Your journey progression logic (${userMessage}) will enable sophisticated treatment pathway analysis.`,
                9: `Wonderful! Your analytics preferences (${userMessage}) will deliver exactly the insights you need.`
            };

            return responses[step] || `Thank you for that valuable input: "${userMessage}". Let me help you with the next step.`;
        }

        function getNextStepContent(step) {
            const indication = conversationData.step1 || selectedIndication || 'your indication';

            const stepContents = {
                2: {
                    question: `Before we dive into the analysis setup for ${indication}, would you like to upload any reports, research papers, or reference materials that could inform our analysis approach?`,
                    suggestions: [
                        'Yes, I have relevant materials to upload',
                        'No, proceed with standard configuration',
                        'I have clinical guidelines to reference',
                        'I have market research reports',
                        'I have previous analysis results to compare'
                    ]
                },
                3: {
                    question: `${getBiomarkerQuestion(indication)}`,
                    suggestions: getIndicationSpecificSuggestions(indication, 'biomarkers_population')
                },
                4: {
                    question: `Great! Now let's define your research objectives for ${indication}. What specific aspects of the patient journey are you most interested in exploring?`,
                    suggestions: getIndicationSpecificSuggestions(indication, 'objectives')
                },
                5: {
                    question: `Excellent! Now let's define your patient population for the ${indication} analysis. Are you interested in all patients or specific subgroups?`,
                    suggestions: getIndicationSpecificSuggestions(indication, 'population')
                },
                6: {
                    question: 'Perfect! Which claims databases would you like to include? Different databases provide different coverage perspectives.',
                    suggestions: [
                        'Commercial claims (Optum, IQVIA)',
                        'Medicare fee-for-service',
                        'Medicaid databases',
                        'Integrated datasets (commercial + Medicare)',
                        'All available databases'
                    ]
                },
                7: {
                    question: `Excellent! Now let's create your market basket analysis for ${indication}. What additional factors should we consider alongside treatment patterns?`,
                    suggestions: getIndicationSpecificSuggestions(indication, 'market_basket')
                },
                8: {
                    question: 'Great! How would you like to define patient cohorts and treatment lines?',
                    suggestions: [
                        'Standard line definitions for this indication',
                        'Intent-to-treat from first systemic therapy',
                        'Per-protocol analysis with treatment gaps',
                        'Include maintenance therapy as continuation',
                        'Custom definitions based on clinical practice'
                    ]
                },
                9: {
                    question: 'Perfect! For episodes and regimens, how should we define treatment episodes?',
                    suggestions: [
                        'Combination regimens as single episodes',
                        'Individual agents tracked separately',
                        'Fixed episode duration based on standard cycles',
                        'Variable episodes based on administration',
                        'Include supportive care medications'
                    ]
                },
                10: {
                    question: 'Excellent! For journey progression, what factors should drive line advancement decisions?',
                    suggestions: [
                        'Standard progression regardless of prior therapy',
                        'Consider prior treatment response patterns',
                        'Include biomarker and resistance considerations',
                        'Factor in toxicity and tolerability issues',
                        'Focus on treatment switches vs. discontinuations'
                    ]
                },
                11: {
                    question: 'Almost there! What specific analytics outputs would be most valuable for your research?',
                    suggestions: [
                        'Treatment pattern visualizations',
                        'Time-to-event analyses',
                        'Healthcare cost breakdowns',
                        'Real-world outcomes metrics',
                        'Comparative effectiveness data'
                    ]
                }
            };

            return stepContents[step] || {
                question: 'Let\'s continue configuring your analysis. What would you like to focus on next?',
                suggestions: ['Continue with standard configuration']
            };
        }

        async function completeGenericSetup() {
            updateOverallProgress(100);

            showTypingIndicator();
            await new Promise(resolve => setTimeout(resolve, 2000));
            hideTypingIndicator();

            const indication = conversationData.step1 || selectedIndication;
            addAIMessage(`🎉 Perfect! Your ${indication} patient journey analysis is now configured and ready. I've set up a comprehensive analysis framework based on all your specifications. You can now proceed to detailed analytics!`);

            // Save the new indication to localStorage for landing page display
            saveNewIndicationToLandingPage(indication);

            // Update status and show completion
            updateLandingPageStatus('completed');

            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                const buttonDiv = document.createElement('div');
                buttonDiv.className = 'flex justify-center mb-6';
                buttonDiv.innerHTML = `
                    <button onclick="goToHome()" class="bg-teal-500 hover:bg-teal-600 text-white px-8 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-home mr-2"></i>
                        Return to Home
                    </button>
                `;
                chatMessages.appendChild(buttonDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);
        }

        function saveNewIndicationToLandingPage(indication) {
            // Get existing custom indications from localStorage
            const customIndications = JSON.parse(localStorage.getItem('customIndications') || '[]');

            // Create indication object
            const indicationId = indication.toLowerCase().replace(/[^a-z0-9]/g, '-');
            const newIndication = {
                id: indicationId,
                name: indication,
                displayName: indication,
                status: 'completed',
                setupDate: new Date().toISOString(),
                setupData: conversationData
            };

            // Check if indication already exists
            const existingIndex = customIndications.findIndex(ind => ind.id === indicationId);
            if (existingIndex >= 0) {
                // Update existing indication
                customIndications[existingIndex] = newIndication;
            } else {
                // Add new indication
                customIndications.push(newIndication);
            }

            // Save back to localStorage
            localStorage.setItem('customIndications', JSON.stringify(customIndications));

            console.log(`Saved new indication: ${indication} (${indicationId}) to landing page`);
        }

        function goToHome() {
            window.location.href = 'index.html';
        }

        function addUserMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-4 mb-6 justify-end';

            messageDiv.innerHTML = `
                <div class="chat-bubble user rounded-lg p-4 text-white">
                    <div class="flex items-center mb-2 justify-end">
                        <span class="text-xs text-white/80 mr-2">Just now</span>
                        <span class="font-medium">You</span>
                    </div>
                    <p>${message}</p>
                </div>
                <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-user text-white text-sm"></i>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addAIMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-4 mb-6';

            messageDiv.innerHTML = `
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="chat-bubble ai rounded-lg p-4 text-white">
                    <div class="flex items-center mb-2">
                        <span class="font-medium">AI Research Assistant</span>
                        <span class="text-xs text-white/60 ml-2">Just now</span>
                    </div>
                    <p>${message}</p>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showSuggestions(suggestions) {
            hideSuggestions();

            const chatMessages = document.getElementById('chatMessages');
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'flex flex-wrap gap-3 mb-6 ml-14';
            suggestionsContainer.id = 'currentSuggestions';

            suggestions.forEach(suggestion => {
                const button = document.createElement('button');
                button.className = 'suggested-response px-4 py-2 rounded-full text-sm text-teal-300 font-medium';
                button.textContent = suggestion;
                button.onclick = () => selectSuggestion(button);
                suggestionsContainer.appendChild(button);
            });

            chatMessages.appendChild(suggestionsContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideSuggestions() {
            const currentSuggestions = document.getElementById('currentSuggestions');
            if (currentSuggestions) {
                currentSuggestions.remove();
            }
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex items-start space-x-4 mb-6';

            typingDiv.innerHTML = `
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="chat-bubble ai rounded-lg p-4 text-white">
                    <div class="flex items-center space-x-2">
                        <div class="typing-indicator w-2 h-2 bg-white/60 rounded-full"></div>
                        <div class="typing-indicator w-2 h-2 bg-white/60 rounded-full" style="animation-delay: 0.2s"></div>
                        <div class="typing-indicator w-2 h-2 bg-white/60 rounded-full" style="animation-delay: 0.4s"></div>
                        <span class="text-white/60 text-sm ml-2">AI is thinking...</span>
                    </div>
                </div>
            `;

            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function updateStepProgress(step, status) {
            const stepElement = document.getElementById(`step${step}`);
            if (!stepElement) return;

            const icon = stepElement.querySelector('i');
            stepElement.classList.remove('active', 'completed');

            if (status === 'active') {
                stepElement.classList.add('active');
                icon.className = 'fas fa-spinner fa-spin text-teal-400';
            } else if (status === 'completed') {
                stepElement.classList.add('completed');
                icon.className = 'fas fa-check text-green-400';
            }
        }

        function updateOverallProgress(percentage) {
            document.getElementById('overallProgress').textContent = Math.round(percentage) + '%';
            document.getElementById('progressBar').style.width = percentage + '%';

            if (percentage < 11) {
                document.getElementById('progressStatus').textContent = 'Selecting indication...';
            } else if (percentage < 22) {
                document.getElementById('progressStatus').textContent = 'Defining objectives...';
            } else {
                document.getElementById('progressStatus').textContent = 'Configuring analysis...';
            }
        }

        function updateLandingPageStatus(status) {
            localStorage.setItem('genericSetupStatus', status);
        }

        function goBack() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>